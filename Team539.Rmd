---
title: "Presidential Election Maps for United Sates from 1920s"
author: "Team FiveThirtyNine"
date: "12/3/2017"
output: html_document
---
# Libraries Needed
```{r, message=F}
library(stringr)
library(dplyr)
library(tidyr)
library(shiny)
library(rvest)
library(ggplot2)
library(maps)
library(leaflet)
library(sf)
library(datamap)
devtools::install_github("hrbrmstr/albersusa")
library(albersusa)
```

# Scraping Data from Wikipedia
Writeup: we scrape data from wikipedia's preidential election pages. Because there are usually more than one tables on one wikipedia page, we filter the desired table by measuring the dimension of table. The table with more than 50 rows is supposed to contain election data by state, and thus we pick that table for each election year. We use regular expression to clean the table scraped (removing all kinds of weird symbols), as well as to standardize column names. Besides, we remove superfluous columns/rows, add column that indicates electoral vote for each state, mutate State column to get abbreviated state names, add a column that indicates winner for each state, and change negative values (such as marginal votes) to their absolute values. For some election years, there are more than onw rows for one specific state: in such case we keep the row with the largest election votes, and remove the rest of the rows.
```{r}
get_election_data=function(year){

  html_str<-paste0("https://en.wikipedia.org/wiki/United_States_presidential_election,_",year,"#Results_by_state")
 
  
  wiki<-read_html(html_str)
  wikitables<-wiki%>%html_nodes(".wikitable.sortable")
  
  for(i in 1:length(wikitables)){
    temp=wikitables[[i]]%>%html_table(fill=TRUE)
    if(nrow(temp)>49)
      {
        result_table=temp
        break
      }
  }
  
  #set uniform column names
  if(year == 1992){
    colnames(result_table)<-paste(result_table[1,],result_table[2,]) %>%
      str_replace_all("\n"," ") %>%
      str_replace_all("^\\s","")
    result_table<-result_table[-c(1,2),]
  }
  else{
    colnames(result_table)<-paste(colnames(result_table),result_table[1,]) %>%
      str_replace_all("\n"," ") %>%
      str_replace_all("^\\s","")
    result_table<-result_table[-1,]
  }
  
  d = result_table
  
  colnames(d) = colnames(d) %>%
    str_replace_all("\\s$","") %>%
    str_replace_all("^E$","electoral votes") %>%
    str_replace_all("(?<!^)[Ee]lectoral votes","E") %>%
    str_replace_all("Top.+/R\\)","Margin") %>%
    str_replace_all("#","Vote") %>%
    str_replace("State [Tt]otal Vote","Total Vote") %>%
    str_replace("State [Tt]otal$|Total State$|^Total$","State Abbr") %>%
    str_replace("State or district","State") %>%
    str_replace_all("\\★","")
  
  #remove superfluous columns
  omit <- c("Electoral method","Total Status")
  d = d[,which(!(colnames(d) %in% omit))]
  
  #formatting dataframe
  dd = apply(d,2,function(x){
    x %>% str_replace_all("–|−","-") %>% str_replace_all("N/A","-") %>%
      str_replace_all("^-$|^$","0") %>% str_replace_all("%","") %>%
      str_replace_all(",","") %>% str_replace_all("\\†","") %>%
      str_replace_all("\\★","")
    }) %>% as.data.frame(stringsAsFactors = FALSE)
  
  #turn appropriate columns into numeric variables
  idx = which(str_detect(colnames(dd),"State"))
  
  dd[,-idx] = lapply(dd[,-idx],as.numeric)
  dd$`Margin Vote`<-abs(dd$`Margin Vote`)
  dd$`Margin %`<-abs(dd$`Margin %`)
  
  
  #add electoral votes column if doesn't already exist
  if(!("electoral votes" %in% colnames(dd))){
    dd = dd %>% mutate(
      elec_vote = rowSums(dd[,str_detect(colnames(dd),"E$")])
    )
    colnames(dd)[colnames(dd) == "elec_vote"] = "electoral votes"
  }
  
  #add winner column and alter state column
  dd = dd %>%
    mutate(Winner = apply(dd,1,function(x){names(
      which.max(x[str_detect(colnames(dd),"E$")])) %>% 
        str_replace("\\sE$","")}),
      State = `State Abbr` %>% str_extract_all("[:upper:]{2}") %>% unlist()
      ) %>% select(-`State Abbr`)
  
  #rename clean output
  clean_table = dd %>%distinct(State,.keep_all = TRUE)

  return(clean_table)
}

# year=2016

test<-get_election_data(1940)

a<-get_election_data(2016)
b<-get_election_data(1992)

```

# Shiny App
In this part, we visualize our election data and output visualizations via a shiny app. We create 2 tab panels for this app: the first shows a U.S. map, which pops up election result of a state when that part is clicked. It also outputs pie charts for popular vote and electoral vote. the second tab panel outputs a table of election results based on users selection. We use package leaflet to create the U.S. map. When an election year is entered and the action button is clicked, the server called get_election_data(year), which returns a tidy dataframe. We mutate a new column called "Party" to indicate the election result for each state, and assign different colors to our visualization map according to this column (blue=democratic, red=republican; the deeper the color, the more that party won that state). Pie charts are created by summing up electoral votes/popular votes from the dataframe. The pop-out part is the most challenging: inspired by Mine's SuperZip app, we create a funciton called pop_content(), which outputs election result (current state, winner, percentage, etc.). Then, when a click is observed, the server calls this function with the state name, the latitude and the longitude of this click.
For the second panel, the choices in selection boxes are generated when the a year is entered by users in the first panel. Based on users selection, the server filter out unwanted rows/columns, and output the desired result as a table.
```{r}
#perhaps we could take cosmetic elements from Mine's SuperZip app: 
#https://shiny.rstudio.com/gallery/superzip-example.html

#map using albersusa
usa <- usa_sf() %>% mutate(State = as.character(iso_3166_2))
pal <- colorNumeric(c("white","red","indianred2",
                      "cornflowerblue","blue","green"),0:5)

shinyApp(
  ui = navbarPage("Electoral College",
    tabPanel("Electoral Map",
        div(class="outer"),
        leafletOutput("map", width="100%",height=600),
        absolutePanel(id = "elec_dat",top = 70,
                   left = 50,right = "auto", bottom = "auto",
                   width = 300, height = "auto", draggable = TRUE, fixed = TRUE,
          #wellPanel(
          h3("Presidential Election App"),
          numericInput("yearr","Year", min = 1920, max = 2016,
                       step = 4, value = 1996),
          actionButton("do", "See Results"),
          checkboxInput("electoral","Display Electoral Votes?",value=FALSE),
          plotOutput("pop_vote"),
          dataTableOutput("elec_vote"),
          style = "opacity: 0.75"
          #)         
        )
    ),
    tabPanel("Election Data",
        sidebarLayout(
          sidebarPanel(
            selectInput("cand","Candidate",choices = NULL),
            selectInput("state","State", choices = NULL),
            actionButton("retrieve", "See Candidate Data")
          ),
        mainPanel(
          dataTableOutput("elec_dat")
        )
      )
    )
  ),
  server = function(input, output, session) 
  {
    
    #reactive values
    data <- eventReactive(input$do,{
      get_election_data(input$yearr)
    })
    
#Panel 1
    #Categorize winning conditions for each state (strong win, weak win, etc)
    k <- reactive({
      data() %>%
        mutate(`Party` = case_when(
          str_detect(.$`Winner`,"Republican") & abs(.$`Margin %`)>10 ~ 1,
          str_detect(.$`Winner`,"Republican") & abs(.$`Margin %`)<=10 ~ 2,
          str_detect(.$`Winner`,"Democratic") & abs(.$`Margin %`)<=10 ~ 3,
          str_detect(.$`Winner`,"Democratic") & abs(.$`Margin %`)>10 ~ 4,
          TRUE ~ 5)) %>%
        select(State,`Winner`,`electoral votes`,`Margin %`,`Party`)
    })
    
    #add some columns
    kk <- reactive({
      left_join(usa,k(), by ="State") %>%
        mutate(`Party` = ifelse(is.na(.$`Party`),0,.$`Party`),
               `electoral votes` = ifelse(
                 is.na(.$`electoral votes`),0,.$`electoral votes`),
               `Margin %` = ifelse(is.na(.$`Margin %`),0,.$`Margin %`))
    })
    

    
    #render pie chart for popular vote/electoral vote
    output$pop_vote <- renderPlot({
       r_lab = colnames(data()) %>% str_extract("\\w+(?=\\sRepublican)") %>%
                   na.omit() %>% unique()
       d_lab = colnames(data()) %>% str_extract("\\w+(?=\\sDemocratic)") %>%
                   na.omit() %>% unique()
      
      if(input$electoral=="FALSE"){
       pi_r = data()[nrow(data()),which(str_detect(
         colnames(data()),"Republican Vote"))[1]]
       pi_d = data()[nrow(data()),which(str_detect(
          colnames(data()),"Democratic Vote"))[1]]
        pi_o = data()[nrow(data()),which(str_detect(
          colnames(data()),"Total Vote"))[1]] - sum(pi_r,pi_d)
        x = c(pi_r,pi_d,pi_o)
      
       pie(x, labels = paste0(round(100*x/sum(x), 1),"%"),
            main = "Popular Vote",col=c("red","blue","grey"))
       legend("topleft",
              c(r_lab[1],d_lab[1],"Others"),
              fill = c("red","blue","grey"), cex = 0.75)
       
      }else{
        pi_r = data()[nrow(data()),which(str_detect(
         colnames(data()),"Republican E"))[1]]
       pi_d = data()[nrow(data()),which(str_detect(
          colnames(data()),"Democratic E"))[1]]
        pi_o = data()[nrow(data()),which(str_detect(
          colnames(data()),"electoral votes"))[1]] - sum(pi_r,pi_d)
        x = c(pi_r,pi_d,pi_o)
        
       
       pie(x, labels = x,
            main = "Electoral Vote",col=c("red","blue","grey"))
       legend("topleft",
              c(r_lab[1],d_lab[1],"Others"),
              fill = c("red","blue","grey"), cex = 0.75)
      }
    })

    
    #render intial map
    output$map <- renderLeaflet({
      leaf = leaflet(usa) %>%
        addPolygons(smoothFactor = 0.2, fillOpacity = 0.8,
                    fillColor = "gray",color = "black",
                    weight = 1, opacity = 1) %>% addLegend(position ="bottomright",
                  colors = c("red","pink","cornflowerblue","blue",
                          "green","white"),
                  labels = c("Strong Rep.","Weak Rep.","Weak Dem.","Strong Dem.",
                  "Other","No Info"),
                  title = "Party")
      })
    #update map with colors
    observe({
      leafletProxy("map", data = kk()) %>%
        addPolygons(smoothFactor = 0.2, fillOpacity = 0.8,
                    fillColor = ~pal(Party),color = "black",
                    weight = 1, opacity = 1, layerId =~name)
    })
    
 
    #check if the click info if correct (this part shall be removed before submission, right?)
    observe({
       if(!is.null(input$map_shape_click)){
         print(input$map_shape_click)
       }
     })
    
    
    #function for popup content
    pop_content <- function(state,lat,lng){
      selectedState = kk() %>% filter(name == state)
      if(is.na(selectedState$`Winner`)){
        content = as.character(tagList(
          tags$h4(selectedState$name),
          sprintf("No Information Available")
        ))

      }else{
        content <-as.character(tagList(
          tags$h4(selectedState$name),
          sprintf("Electoral votes: %s", selectedState$`electoral votes`),tags$br(),
          sprintf("Winner: %s",selectedState$`Winner`),tags$br(),
          sprintf("Margin: %s%%",abs(selectedState$`Margin %`))
        ))
      }

      leafletProxy("map") %>% addPopups(lng, lat, content, layerId = state)
    }
    #when a click is observed, check if it is valid: if it is, then call the previous function to pop up contents.
    observe({
      leafletProxy("map") %>% clearPopups()
      event <- input$map_shape_click
      if(is.null(event)){
       return()
      }
      isolate({
        pop_content(event$id,event$lat,event$lng)
      })
    }) 

    
 #Panel 2   
    
    #update select choices for panel 2
    list_cand<-eventReactive(input$do,{
      colnames(data()) %>%
        str_extract("^(?!Other[s\\s]|Total|Margin)(.*?)[:upper:]\\w+(.*?)[:upper:]\\w{2,}")%>%
        na.omit()%>%unique()
    })
    observe({
      updateSelectInput(session, "cand","Candidate",
                      choices=c("none",list_cand()))
    })
    
    observe({
      updateSelectInput(session, "state","State",
                      choices=c("none",data()$State))
    })
    
    #output dataTable based on users selection for panel 2
    cand_table<-eventReactive(input$retrieve,{
       if(input$cand!="none"&&input$state!="none"){
        a<-data()%>%select(starts_with(input$cand))
        aa<-cbind(data()$State,a)
        colnames(aa)<-c("State","Popular Vote","Percentage","Electoral Vote")
        aa%>%filter(State==input$state)
       }else if(input$state=="none"&&input$cand!="none"){
         a<-data()%>%select(starts_with(input$cand))
         aa<-cbind(data()$State,a)
         colnames(aa)<-c("State","Popular Vote","Percentage","Electoral Vote")
         aa
       }else if(input$state!="none"&&input$cand=="none"){
         a<-data()%>%filter(State==input$state)
         # aa<-as.data.frame(t(a))
        a
       }else{
         NULL
       }
      
    })
    output$elec_dat<-renderDataTable(
      cand_table())
      
  }
  
)

```




#Below and up functions are nearly the same, so pick the more simple one

```{r}
# get_election_data=function(year){
# 
#   html_str<-paste0("https://en.wikipedia.org/wiki/United_States_presidential_election,_",year,"#Results_by_state")
#    wiki<-read_html(html_str)
#   wikitables<-wiki%>%html_nodes(".wikitable.sortable")
# 
#   for(i in 1:length(wikitables)){
#     temp=wikitables[[i]]%>%html_table(fill=TRUE)
#     if(nrow(temp)>49 & nrow(temp) < 60)
#       {
#         result_table=temp
#         break
#       }
#   }
# 
#   if(year == 1992){
#     result_table[1,]=str_replace_all(result_table[1,],"^.*(?<=\\))","Margin")
#     result_table =  result_table %>%  `colnames<-`(paste( result_table[1,], result_table[2,])) %>%slice(-1:-2)
#       }else{
#     result_table = result_table %>% `colnames<-`(paste0(colnames(result_table),result_table[1,])) %>% slice(-1)
#     }
#   return(result_table)
# }


```

# Draw US map
```{r}
# # way 1
# mapStates<-map("state",fill=TRUE,plot=FALSE)
# leaflet(data=mapStates)%>%addTiles()%>%addPolygons(fillColor = topo.colors(10,alpha=NULL),stroke = FALSE)
# 
# # way 2
# all_states <- map_data("state")
# ggplot()+
#   geom_polygon(data=all_states, aes(x=long, y=lat, group=group),colour="white")
# 
# #using albersusa
# usa <- usa_sf() %>% mutate(State = as.character(iso_3166_2))
# k <- b %>% select(State,`Winner`,`electoral votes`,`Margin %`) %>%
#   mutate(`Winner` = ifelse(str_detect(.$`Winner`,"Republican"),1,
#                            ifelse(str_detect(.$`Winner`,"Democratic"),2,3))
#          )
# kk <- left_join(usa,k, by ="State")
# kk[is.na(kk)] <- 0
# 
# pal <- colorNumeric(c("white","red","blue","green"),0:3)
# map <- leaflet(kk) %>%
#   addPolygons(smoothFactor = 0.2, fillOpacity = 0.8,
#               fillColor = ~pal(Winner),color = "black", weight = 1, opacity = 1)
# 
# #using datamap
# us_state_map <- Datamaps$new()
# us_state_map$set(
#   scope = 'usa',
#   legend = TRUE,
#   labels = TRUE
# )
# 
# #test of pie chart
# pi_r = b[nrow(b),which(str_detect(colnames(test),"Republican Vote"))][[1]]
# pi_d = b[nrow(b),which(str_detect(colnames(test),"Democratic Vote"))][[1]]
# pi_o = b[nrow(b),which(str_detect(colnames(test),"Total Vote"))][[1]] - sum(pi_r,pi_d)
# x<-c(pi_r,pi_d,pi_o)
# 
# pie(x, labels = paste0(round(100*x/sum(x), 1),"%"), main = "Popular Vote",col=c("red","blue","grey"))
# legend("topright",
#        c(colnames(b) %>% str_extract("\\w+(?=\\sRepublican)") %>%
#            na.omit() %>% unique(),
#          colnames(b) %>% str_extract("\\w+(?=\\sDemocratic)") %>%
#            na.omit() %>% unique(),"Others"),
#        fill = c("red","blue","grey"))
```


